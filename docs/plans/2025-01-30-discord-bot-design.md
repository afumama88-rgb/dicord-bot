# Discord Bot å®Œæ•´è¨­è¨ˆæ–‡ä»¶ v2.0

> å»ºç«‹æ—¥æœŸï¼š2025-01-30
> æœ€å¾Œæ›´æ–°ï¼š2025-01-30
> æŠ€è¡“é¸å‹ï¼šNode.js + Discord.js v14.25.1
> éƒ¨ç½²å¹³å°ï¼šZeabur

---

## ç›®éŒ„

1. [ç³»çµ±æ¶æ§‹ç¸½è¦½](#1-ç³»çµ±æ¶æ§‹ç¸½è¦½)
2. [æŠ€è¡“é¸å‹èˆ‡ç‰ˆæœ¬](#2-æŠ€è¡“é¸å‹èˆ‡ç‰ˆæœ¬)
3. [Discord Server çµæ§‹](#3-discord-server-çµæ§‹)
4. [åŠŸèƒ½ä¸€ï¼šè³‡è¨Šæ”¶é›†](#4-åŠŸèƒ½ä¸€è³‡è¨Šæ”¶é›†)
5. [åŠŸèƒ½äºŒï¼šè¡Œäº‹æ›†åŠ©æ‰‹](#5-åŠŸèƒ½äºŒè¡Œäº‹æ›†åŠ©æ‰‹)
6. [Notion è³‡æ–™åº«è¨­è¨ˆ](#6-notion-è³‡æ–™åº«è¨­è¨ˆ)
7. [Discord äº’å‹•å…ƒä»¶è¨­è¨ˆ](#7-discord-äº’å‹•å…ƒä»¶è¨­è¨ˆ)
8. [éŒ¯èª¤è™•ç†ç­–ç•¥](#8-éŒ¯èª¤è™•ç†ç­–ç•¥)
9. [ç’°å¢ƒè®Šæ•¸é…ç½®](#9-ç’°å¢ƒè®Šæ•¸é…ç½®)
10. [å°ˆæ¡ˆæª”æ¡ˆçµæ§‹](#10-å°ˆæ¡ˆæª”æ¡ˆçµæ§‹)
11. [éƒ¨ç½²è¦åŠƒ](#11-éƒ¨ç½²è¦åŠƒ)
12. [æœªä¾†æ“´å……](#12-æœªä¾†æ“´å……)

---

## 1. ç³»çµ±æ¶æ§‹ç¸½è¦½

### 1.1 æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ä½¿ç”¨è€…äº’å‹•å±¤                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ #è³‡è¨Šæ”¶é›†   â”‚  â”‚ #è¡Œäº‹æ›†åŠ©æ‰‹  â”‚  â”‚ #bot-é€šçŸ¥   â”‚                      â”‚
â”‚  â”‚ é »é“        â”‚  â”‚ é »é“        â”‚  â”‚ é »é“        â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Discord Bot (Node.js + discord.js 14.25.1)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        äº‹ä»¶è™•ç†å±¤ (Events)                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚messageCreate â”‚  â”‚interaction   â”‚  â”‚messageReactionâ”‚             â”‚ â”‚
â”‚  â”‚  â”‚ç›£è½æ–°è¨Šæ¯     â”‚  â”‚Create        â”‚  â”‚Add           â”‚              â”‚ â”‚
â”‚  â”‚  â”‚              â”‚  â”‚æŒ‰éˆ•/é¸å–®äº’å‹•  â”‚  â”‚åæ‡‰äº‹ä»¶       â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                 â”‚                 â”‚                        â”‚
â”‚            â–¼                 â–¼                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        è™•ç†å™¨å±¤ (Handlers)                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚UrlHandler    â”‚  â”‚MediaHandler  â”‚  â”‚TextHandler   â”‚              â”‚ â”‚
â”‚  â”‚  â”‚è™•ç†å„é¡é€£çµ   â”‚  â”‚è™•ç†åœ–ç‰‡/PDF  â”‚  â”‚è™•ç†ç´”æ–‡å­—    â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                 â”‚                 â”‚                        â”‚
â”‚            â–¼                 â–¼                 â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        æœå‹™å±¤ (Services)                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚ â”‚
â”‚  â”‚  â”‚ Notion  â”‚ â”‚ Google  â”‚ â”‚ Gemini  â”‚ â”‚ Apify   â”‚ â”‚Scraper  â”‚      â”‚ â”‚
â”‚  â”‚  â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Service â”‚ â”‚Service  â”‚      â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚           â”‚           â”‚           â”‚           â”‚
           â–¼           â–¼           â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Notion     â”‚ â”‚   Google     â”‚ â”‚   Gemini     â”‚ â”‚   Apify      â”‚
â”‚   API        â”‚ â”‚ Calendar API â”‚ â”‚   API        â”‚ â”‚   API        â”‚
â”‚   v2025-09-03â”‚ â”‚ Tasks API    â”‚ â”‚ 2.5-flash    â”‚ â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è³‡æ–™æµå‘

**è³‡è¨Šæ”¶é›†æµç¨‹ï¼š**
```
ä½¿ç”¨è€…è²¼é€£çµ â†’ Bot åµæ¸¬ URL é¡å‹ â†’ å°æ‡‰çˆ¬èŸ²æŠ“å– â†’ AI ç”Ÿæˆæ‘˜è¦ â†’ å­˜å…¥ Notion â†’ å›è¦† Embed
```

**è¡Œäº‹æ›†åŠ©æ‰‹æµç¨‹ï¼š**
```
ä½¿ç”¨è€…å‚³é€æ–‡å­—/åœ–ç‰‡/PDF â†’ Gemini 2.5 Flash è§£æ â†’ æå–æ—¥æœŸè³‡è¨Š â†’ é¡¯ç¤ºé è¦½ Embed
â†’ ä½¿ç”¨è€…é»é¸æŒ‰éˆ• â†’ å»ºç«‹ Google Calendar/Tasks + å­˜å…¥ Notion â†’ å›è¦†ç¢ºèª
```

---

## 2. æŠ€è¡“é¸å‹èˆ‡ç‰ˆæœ¬

### 2.1 æ ¸å¿ƒå¥—ä»¶ç‰ˆæœ¬ï¼ˆ2025-01-30 æœ€æ–°ï¼‰

| å¥—ä»¶ | ç‰ˆæœ¬ | ç”¨é€” | å‚™è¨» |
|------|------|------|------|
| `discord.js` | 14.25.1 | Discord Bot æ¡†æ¶ | æœ€æ–°ç©©å®šç‰ˆ |
| `@google/genai` | 1.37.0 | Gemini AI API | **æ–°ç‰ˆå¥—ä»¶**ï¼Œå–ä»£å·²æ£„ç”¨çš„ @google/generative-ai |
| `@notionhq/client` | 5.7.0 | Notion API | å°æ‡‰ API v2025-09-03 |
| `googleapis` | latest | Google Calendar/Tasks | OAuth2 èªè­‰ |
| `apify-client` | latest | ç¤¾ç¾¤åª’é«”çˆ¬èŸ² | FB/IG/Threads |
| `cheerio` | latest | éœæ…‹ç¶²é è§£æ | è¼•é‡å¿«é€Ÿ |
| `playwright` | latest | å‹•æ…‹ç¶²é çˆ¬èŸ² | å‚™ç”¨æ–¹æ¡ˆ |
| `pdf-parse` | latest | PDF æ–‡å­—æå– | - |

### 2.2 Gemini æ¨¡å‹é¸æ“‡

| æ¨¡å‹ | ç”¨é€” | å‚™è¨» |
|------|------|------|
| `gemini-2.5-flash` | **ä¸»è¦ä½¿ç”¨** | ç©©å®šã€åƒ¹æ ¼ä½ã€é€Ÿåº¦å¿« |
| `gemini-3-flash-preview` | å‚™ç”¨å‡ç´š | æ•ˆèƒ½æ›´å¥½ä½†ä»åœ¨é è¦½ |

**âš ï¸ é‡è¦ï¼š`@google/generative-ai` å·²æ£„ç”¨ï¼Œå¿…é ˆä½¿ç”¨ `@google/genai`**

### 2.3 API ç‰ˆæœ¬å°æ‡‰

| æœå‹™ | API ç‰ˆæœ¬ | SDK ç‰ˆæœ¬ |
|------|---------|---------|
| Notion | 2025-09-03 | v5.7.0 |
| Discord | v10 | discord.js 14.25.1 |
| Google Calendar | v3 | googleapis latest |
| Google Tasks | v1 | googleapis latest |

---

## 3. Discord Server çµæ§‹

### 3.1 é »é“é…ç½®

```
ğŸ“ â•â•â• è‡ªå‹•åŒ–å·¥å…· â•â•â•
â”œâ”€â”€ #è³‡è¨Šæ”¶é›†          [æ–‡å­—é »é“]
â”‚   â””â”€â”€ ç”¨é€”ï¼šè²¼é€£çµï¼ˆYT/FB/IG/Threads/ç¶²é ï¼‰ã€æ–‡å­—ç­†è¨˜
â”‚   â””â”€â”€ Bot æ¬Šé™ï¼šè®€å–è¨Šæ¯ã€ç™¼é€è¨Šæ¯ã€åµŒå…¥é€£çµã€æ·»åŠ åæ‡‰ã€ç®¡ç†è¨Šæ¯
â”‚
â”œâ”€â”€ #è¡Œäº‹æ›†åŠ©æ‰‹        [æ–‡å­—é »é“]
â”‚   â””â”€â”€ ç”¨é€”ï¼šä¸Ÿæ–‡å­—/åœ–ç‰‡/PDFï¼ŒAI è§£æå¾Œå»ºç«‹è¡Œäº‹æ›†
â”‚   â””â”€â”€ Bot æ¬Šé™ï¼šè®€å–è¨Šæ¯ã€ç™¼é€è¨Šæ¯ã€åµŒå…¥é€£çµã€é™„åŠ æª”æ¡ˆã€æ·»åŠ åæ‡‰
â”‚
â””â”€â”€ #bot-é€šçŸ¥          [æ–‡å­—é »é“]
    â””â”€â”€ ç”¨é€”ï¼šBot ç³»çµ±è¨Šæ¯ã€éŒ¯èª¤å›å ±
    â””â”€â”€ Bot æ¬Šé™ï¼šç™¼é€è¨Šæ¯ã€åµŒå…¥é€£çµ
```

### 3.2 Bot æ¬Šé™éœ€æ±‚

**Developer Portal è¨­å®šï¼š**
1. é€²å…¥ Bot é é¢
2. é–‹å•Ÿ **Privileged Gateway Intents**:
   - âœ… MESSAGE CONTENT INTENTï¼ˆå¿…é ˆï¼ï¼‰
   - âœ… SERVER MEMBERS INTENTï¼ˆé¸å¡«ï¼‰

**ç¨‹å¼ç¢¼ Intents è¨­å®šï¼š**
```javascript
const { Client, GatewayIntentBits } = require('discord.js');

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,      // å¿…é ˆåœ¨ Portal é–‹å•Ÿ
    GatewayIntentBits.GuildMessageReactions
  ]
});
```

**OAuth2 é‚€è«‹é€£çµæ¬Šé™ï¼ˆPermissions Integer: 277025770560ï¼‰ï¼š**
- Read Messages/View Channels
- Send Messages
- Embed Links
- Attach Files
- Add Reactions
- Use External Emojis
- Manage Messages
- Read Message History

---

## 4. åŠŸèƒ½ä¸€ï¼šè³‡è¨Šæ”¶é›†

### 4.1 æ”¯æ´çš„å…§å®¹é¡å‹

| é¡å‹ | åµæ¸¬æ–¹å¼ | è™•ç†æ–¹æ³• | Notion type æ¬„ä½ |
|------|---------|---------|-----------------|
| YouTube | `youtube.com`, `youtu.be` | oEmbed + ç¸®åœ– URL | `YT` |
| Facebook | `facebook.com`, `fb.watch` | Apify Scraper | `FB` |
| Instagram | `instagram.com` | Apify Scraper | `IG` |
| Threads | `threads.net` | Apify Scraper | `TH` |
| ä¸€èˆ¬ç¶²é  | å…¶ä»– URL | Cheerio + Readability | `ç¶²è·¯æ–‡ç« ` |
| ç´”æ–‡å­—ç­†è¨˜ | ç„¡ URL | ç›´æ¥å­˜å…¥ | `æ–‡å­—é€Ÿè¨˜` |

### 4.2 URL è§£æé‚è¼¯

```javascript
// utils/urlParser.js

const URL_PATTERNS = {
  youtube: [
    /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/,
    /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]+)/,
    /(?:https?:\/\/)?(?:www\.)?youtube\.com\/shorts\/([a-zA-Z0-9_-]+)/
  ],
  facebook: [
    /(?:https?:\/\/)?(?:www\.)?facebook\.com\/.+/,
    /(?:https?:\/\/)?(?:www\.)?fb\.watch\/.+/,
    /(?:https?:\/\/)?(?:www\.)?fb\.com\/.+/
  ],
  instagram: [
    /(?:https?:\/\/)?(?:www\.)?instagram\.com\/(?:p|reel|tv)\/([a-zA-Z0-9_-]+)/
  ],
  threads: [
    /(?:https?:\/\/)?(?:www\.)?threads\.net\/@?[\w.]+\/post\/([a-zA-Z0-9_-]+)/
  ]
};

/**
 * è§£æ URL é¡å‹
 * @param {string} url - è¦è§£æçš„ URL
 * @returns {{ type: string, url: string, match: RegExpMatchArray | null } | null}
 */
function parseUrl(url) {
  for (const [type, patterns] of Object.entries(URL_PATTERNS)) {
    for (const pattern of patterns) {
      if (pattern.test(url)) {
        return { type, url, match: url.match(pattern) };
      }
    }
  }

  // å¦‚æœæ˜¯æœ‰æ•ˆ URL ä½†ä¸ç¬¦åˆä¸Šè¿°ï¼Œè¦–ç‚ºä¸€èˆ¬ç¶²é 
  if (/^https?:\/\/.+/.test(url)) {
    return { type: 'web', url, match: null };
  }

  return null;
}

/**
 * å¾æ–‡å­—ä¸­æå–æ‰€æœ‰ URL
 * @param {string} text - è¦è§£æçš„æ–‡å­—
 * @returns {string[]}
 */
function extractUrls(text) {
  const urlRegex = /https?:\/\/[^\s<>\"{}|\\^`\[\]]+/g;
  return text.match(urlRegex) || [];
}

module.exports = { parseUrl, extractUrls, URL_PATTERNS };
```

### 4.3 YouTube è™•ç†ï¼ˆç„¡éœ€ API Keyï¼‰

```javascript
// services/youtube.js

/**
 * å¾ YouTube URL æå–å½±ç‰‡ ID
 */
function extractVideoId(url) {
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]+)/
  ];

  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }
  return null;
}

/**
 * ä½¿ç”¨ oEmbed å–å¾— YouTube å½±ç‰‡è³‡è¨Šï¼ˆå…è²»ã€ç„¡éœ€ API Keyï¼‰
 */
async function getYouTubeInfo(url) {
  const videoId = extractVideoId(url);
  if (!videoId) throw new Error('ç„¡æ•ˆçš„ YouTube URL');

  // æ–¹æ³•ä¸€ï¼šoEmbed APIï¼ˆæœ€ç©©å®šï¼‰
  const oembedUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`;

  try {
    const response = await fetch(oembedUrl);
    if (!response.ok) throw new Error('oEmbed è«‹æ±‚å¤±æ•—');

    const data = await response.json();

    return {
      title: data.title,
      author: data.author_name,
      authorUrl: data.author_url,
      thumbnail: `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`,
      url: url,
      videoId: videoId,
      type: 'YT'
    };
  } catch (error) {
    // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ§‹å»ºåŸºæœ¬è³‡è¨Š
    return {
      title: 'ç„¡æ³•å–å¾—æ¨™é¡Œ',
      author: 'æœªçŸ¥',
      thumbnail: `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`,
      url: url,
      videoId: videoId,
      type: 'YT'
    };
  }
}

module.exports = { extractVideoId, getYouTubeInfo };
```

### 4.4 ç¤¾ç¾¤åª’é«”è™•ç†ï¼ˆApifyï¼‰

```javascript
// services/apify.js

const { ApifyClient } = require('apify-client');

const apifyClient = new ApifyClient({
  token: process.env.APIFY_API_KEY
});

const APIFY_ACTORS = {
  facebook: 'apify/facebook-posts-scraper',
  instagram: 'apify/instagram-api-scraper',
  threads: 'apify/threads-scraper'
};

/**
 * ä½¿ç”¨ Apify çˆ¬å–ç¤¾ç¾¤åª’é«”è²¼æ–‡
 * @param {string} url - è²¼æ–‡ URL
 * @param {'facebook' | 'instagram' | 'threads'} platform - å¹³å°é¡å‹
 */
async function scrapeSocialMedia(url, platform) {
  const actorId = APIFY_ACTORS[platform];
  if (!actorId) throw new Error(`ä¸æ”¯æ´çš„å¹³å°: ${platform}`);

  try {
    const run = await apifyClient.actor(actorId).call({
      startUrls: [{ url }],
      resultsLimit: 1
    });

    const { items } = await apifyClient.dataset(run.defaultDatasetId).listItems();

    if (!items || items.length === 0) {
      throw new Error('ç„¡æ³•å–å¾—è²¼æ–‡å…§å®¹');
    }

    const post = items[0];

    return {
      title: post.text?.slice(0, 100) || 'ç„¡æ¨™é¡Œ',
      description: post.text || '',
      thumbnail: post.imageUrl || post.thumbnailUrl || post.displayUrl,
      author: post.authorName || post.ownerUsername || post.username,
      url: url,
      type: platform.toUpperCase().slice(0, 2), // FB, IG, TH
      likes: post.likesCount || post.likeCount,
      comments: post.commentsCount || post.commentCount,
      timestamp: post.timestamp || post.takenAt
    };
  } catch (error) {
    console.error(`Apify çˆ¬å–å¤±æ•— (${platform}):`, error.message);

    // é™ç´šè™•ç†ï¼šåªå„²å­˜ URL
    return {
      title: `${platform} è²¼æ–‡`,
      description: 'ç„¡æ³•æ“·å–å…§å®¹',
      url: url,
      type: platform.toUpperCase().slice(0, 2),
      error: error.message
    };
  }
}

module.exports = { scrapeSocialMedia, APIFY_ACTORS };
```

### 4.5 ä¸€èˆ¬ç¶²é è™•ç†

```javascript
// services/scraper.js

const cheerio = require('cheerio');
const { Readability } = require('@mozilla/readability');
const { JSDOM } = require('jsdom');

/**
 * çˆ¬å–ä¸€èˆ¬ç¶²é å…§å®¹
 * @param {string} url - ç¶²é  URL
 */
async function scrapeWebPage(url) {
  const response = await fetch(url, {
    headers: {
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    }
  });

  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`);
  }

  const html = await response.text();

  // ä½¿ç”¨ Cheerio æå– Open Graph æ¨™ç±¤
  const $ = cheerio.load(html);
  const ogTitle = $('meta[property="og:title"]').attr('content');
  const ogDescription = $('meta[property="og:description"]').attr('content');
  const ogImage = $('meta[property="og:image"]').attr('content');
  const ogSiteName = $('meta[property="og:site_name"]').attr('content');

  // ä½¿ç”¨ Readability æå–ä¸»è¦å…§å®¹
  let article = null;
  try {
    const dom = new JSDOM(html, { url });
    const reader = new Readability(dom.window.document);
    article = reader.parse();
  } catch (e) {
    console.warn('Readability è§£æå¤±æ•—:', e.message);
  }

  return {
    title: ogTitle || article?.title || $('title').text() || 'æœªçŸ¥æ¨™é¡Œ',
    description: ogDescription || article?.excerpt || '',
    content: article?.textContent?.slice(0, 5000), // é™åˆ¶é•·åº¦
    thumbnail: ogImage,
    author: article?.byline || $('meta[name="author"]').attr('content'),
    url: url,
    type: 'ç¶²è·¯æ–‡ç« ',
    siteName: ogSiteName
  };
}

module.exports = { scrapeWebPage };
```

### 4.6 åæ‡‰äº’å‹•åŠŸèƒ½

```javascript
// events/messageReactionAdd.js

const REACTION_ACTIONS = {
  'ğŸ“Œ': 'markImportant',    // æ¨™è¨˜é‡è¦ â†’ Notion priority: é«˜
  'âœ…': 'markRead',         // æ¨™è¨˜å·²è®€ â†’ Notion status: å·²è®€
  'ğŸ—‘ï¸': 'deleteFromNotion', // å¾ Notion åˆªé™¤ï¼ˆå°å­˜ï¼‰
};

/**
 * è™•ç†åæ‡‰äº‹ä»¶
 */
async function handleReactionAdd(reaction, user, notionService) {
  // å¿½ç•¥ Bot è‡ªå·±çš„åæ‡‰
  if (user.bot) return;

  const action = REACTION_ACTIONS[reaction.emoji.name];
  if (!action) return;

  // å¾ Embed footer å–å¾— Notion page ID
  const embed = reaction.message.embeds[0];
  if (!embed?.footer?.text) return;

  const match = embed.footer.text.match(/ID: ([a-f0-9-]+)/);
  if (!match) return;

  const notionPageId = match[1];

  try {
    switch (action) {
      case 'markImportant':
        await notionService.updatePage(notionPageId, {
          'å„ªå…ˆç´š': { select: { name: 'é«˜' } }
        });
        break;

      case 'markRead':
        await notionService.updatePage(notionPageId, {
          'status': { select: { name: 'å·²è®€' } }
        });
        break;

      case 'deleteFromNotion':
        await notionService.archivePage(notionPageId);
        await reaction.message.react('ğŸ—‘ï¸');
        break;
    }
  } catch (error) {
    console.error('åæ‡‰è™•ç†å¤±æ•—:', error);
  }
}

module.exports = { handleReactionAdd, REACTION_ACTIONS };
```

---

## 5. åŠŸèƒ½äºŒï¼šè¡Œäº‹æ›†åŠ©æ‰‹

### 5.1 æ”¯æ´çš„è¼¸å…¥é¡å‹

| è¼¸å…¥é¡å‹ | è™•ç†æ–¹å¼ | ç¯„ä¾‹ |
|---------|---------|------|
| ç´”æ–‡å­— | Gemini 2.5 Flash è§£æ | ã€Œä¸‹é€±ä¸‰ä¸‹åˆå…©é»è¦é–‹æœƒã€ |
| åœ–ç‰‡ | Gemini 2.5 Flash Vision | ç ”ç¿’æµ·å ±ç…§ç‰‡ |
| PDF | pdf-parse è½‰æ–‡å­— + Gemini | å…¬æ–‡ PDF æª”æ¡ˆ |

### 5.2 Gemini æœå‹™ï¼ˆä½¿ç”¨æ–°ç‰ˆ @google/genaiï¼‰

```javascript
// services/gemini.js

const { GoogleGenAI } = require('@google/genai');
const fs = require('node:fs');

// åˆå§‹åŒ– Gemini å®¢æˆ¶ç«¯
const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });

// æ¨¡å‹è¨­å®šï¼ˆå¯é€éç’°å¢ƒè®Šæ•¸åˆ‡æ›ï¼‰
const MODEL = process.env.GEMINI_MODEL || 'gemini-2.5-flash';

/**
 * è¡Œäº‹æ›†è³‡è¨Šæå– Prompt
 */
const CALENDAR_EXTRACTION_PROMPT = `
ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è¡Œæ”¿åŠ©ç†ï¼Œå°ˆé–€å¾æ–‡å­—æˆ–åœ–ç‰‡ä¸­æå–è¡Œäº‹æ›†ç›¸é—œè³‡è¨Šã€‚

è«‹å¾ä»¥ä¸‹å…§å®¹ä¸­æå–ï¼š
1. æ´»å‹•/ä»»å‹™åç¨±
2. æ—¥æœŸï¼ˆè«‹è½‰æ›ç‚º YYYY-MM-DD æ ¼å¼ï¼‰
3. æ™‚é–“ï¼ˆå¦‚æœ‰ï¼Œè«‹è½‰æ›ç‚º HH:MM æ ¼å¼ï¼‰
4. çµæŸæ™‚é–“ï¼ˆå¦‚æœ‰ï¼‰
5. åœ°é»ï¼ˆå¦‚æœ‰ï¼‰
6. é‡è¦æˆªæ­¢æ—¥æœŸï¼ˆå¦‚å ±åæˆªæ­¢æ—¥ï¼‰
7. è¯çµ¡äººè³‡è¨Šï¼ˆå¦‚æœ‰ï¼‰
8. é€™æ˜¯ã€Œæ´»å‹•ã€é‚„æ˜¯ã€Œä»»å‹™ã€ï¼Ÿ
   - æ´»å‹•ï¼šæœ‰æ˜ç¢ºçš„èˆ‰è¾¦æ™‚é–“ï¼Œéœ€è¦å‡ºå¸­
   - ä»»å‹™ï¼šéœ€è¦åœ¨æŸå€‹æœŸé™å‰å®Œæˆçš„äº‹é …

è«‹ä»¥ JSON æ ¼å¼å›è¦†ï¼Œä¸è¦åŒ…å« markdown code blockï¼š
{
  "title": "æ´»å‹•/ä»»å‹™åç¨±",
  "type": "event" | "task",
  "startDate": "YYYY-MM-DD",
  "startTime": "HH:MM" | null,
  "endDate": "YYYY-MM-DD" | null,
  "endTime": "HH:MM" | null,
  "location": "åœ°é»" | null,
  "deadline": "YYYY-MM-DD" | null,
  "deadlineDescription": "æˆªæ­¢äº‹é …èªªæ˜" | null,
  "contact": {
    "name": "è¯çµ¡äºº" | null,
    "phone": "é›»è©±" | null,
    "email": "ä¿¡ç®±" | null
  },
  "priority": "é«˜" | "ä¸­" | "ä½",
  "summary": "50å­—ä»¥å…§çš„æ‘˜è¦",
  "confidence": 0.0-1.0
}

å¦‚æœç„¡æ³•ç¢ºå®šæŸå€‹æ¬„ä½ï¼Œè«‹è¨­ç‚º nullã€‚
å¦‚æœå…§å®¹ä¸­æ²’æœ‰ä»»ä½•æ—¥æœŸè³‡è¨Šï¼Œè«‹å°‡ confidence è¨­ç‚º 0ã€‚

ä»Šå¤©æ—¥æœŸï¼š${new Date().toISOString().split('T')[0]}
`;

/**
 * å¾æ–‡å­—ä¸­æå–è¡Œäº‹æ›†è³‡è¨Š
 * @param {string} text - è¦åˆ†æçš„æ–‡å­—
 */
async function extractCalendarFromText(text) {
  const response = await ai.models.generateContent({
    model: MODEL,
    contents: [
      { text: CALENDAR_EXTRACTION_PROMPT },
      { text: `\n\nä»¥ä¸‹æ˜¯è¦åˆ†æçš„å…§å®¹ï¼š\n${text}` }
    ]
  });

  return parseGeminiResponse(response.text);
}

/**
 * å¾åœ–ç‰‡ä¸­æå–è¡Œäº‹æ›†è³‡è¨Š
 * @param {Buffer} imageBuffer - åœ–ç‰‡ Buffer
 * @param {string} mimeType - åœ–ç‰‡ MIME é¡å‹
 */
async function extractCalendarFromImage(imageBuffer, mimeType) {
  const base64Image = imageBuffer.toString('base64');

  const response = await ai.models.generateContent({
    model: MODEL,
    contents: [
      { text: CALENDAR_EXTRACTION_PROMPT },
      {
        inlineData: {
          mimeType: mimeType,
          data: base64Image
        }
      }
    ]
  });

  return parseGeminiResponse(response.text);
}

/**
 * ç”Ÿæˆæ–‡å­—æ‘˜è¦ï¼ˆç”¨æ–¼æ–‡å­—ç­†è¨˜æ¨™é¡Œï¼‰
 * @param {string} text - è¦æ‘˜è¦çš„æ–‡å­—
 * @param {number} maxLength - æœ€å¤§é•·åº¦
 */
async function generateSummary(text, maxLength = 50) {
  const response = await ai.models.generateContent({
    model: MODEL,
    contents: [
      { text: `è«‹ç”¨ä¸è¶…é ${maxLength} å€‹å­—æ‘˜è¦ä»¥ä¸‹å…§å®¹ï¼Œåªå›è¦†æ‘˜è¦æ–‡å­—ï¼Œä¸è¦åŠ å¼•è™Ÿæˆ–å…¶ä»–æ ¼å¼ï¼š\n\n${text}` }
    ]
  });

  return response.text.trim().slice(0, maxLength);
}

/**
 * è§£æ Gemini å›æ‡‰
 */
function parseGeminiResponse(responseText) {
  // ç§»é™¤å¯èƒ½çš„ markdown code block
  let jsonStr = responseText
    .replace(/```json\n?/g, '')
    .replace(/```\n?/g, '')
    .trim();

  try {
    return JSON.parse(jsonStr);
  } catch (error) {
    console.error('Gemini å›æ‡‰è§£æå¤±æ•—:', responseText);
    throw new Error('AI å›æ‡‰æ ¼å¼éŒ¯èª¤');
  }
}

module.exports = {
  extractCalendarFromText,
  extractCalendarFromImage,
  generateSummary,
  MODEL
};
```

### 5.3 åœ–ç‰‡è™•ç†æµç¨‹

```javascript
// handlers/mediaHandler.js

const geminiService = require('../services/gemini');
const { cacheAnalysis } = require('../utils/cache');
const { createCalendarPreview } = require('../components/embeds/calendarPreviewEmbed');

// æ”¯æ´çš„åœ–ç‰‡é¡å‹
const SUPPORTED_IMAGE_TYPES = [
  'image/jpeg',
  'image/png',
  'image/gif',
  'image/webp',
  'image/heic',
  'image/heif'
];

/**
 * è™•ç†åœ–ç‰‡è¨Šæ¯
 */
async function handleImageMessage(message) {
  const attachment = message.attachments.first();

  // é©—è­‰æª”æ¡ˆé¡å‹
  if (!SUPPORTED_IMAGE_TYPES.includes(attachment.contentType)) {
    return await message.reply('âŒ ä¸æ”¯æ´çš„åœ–ç‰‡æ ¼å¼ã€‚æ”¯æ´ï¼šJPGã€PNGã€GIFã€WebPã€HEIC');
  }

  // é©—è­‰æª”æ¡ˆå¤§å°ï¼ˆGemini é™åˆ¶ 20MBï¼‰
  const MAX_SIZE = 20 * 1024 * 1024;
  if (attachment.size > MAX_SIZE) {
    return await message.reply('âŒ åœ–ç‰‡å¤ªå¤§ï¼Œè«‹ä½¿ç”¨å°æ–¼ 20MB çš„åœ–ç‰‡');
  }

  // åŠ ä¸Šè™•ç†ä¸­åæ‡‰
  await message.react('â³');

  try {
    // ä¸‹è¼‰åœ–ç‰‡
    const response = await fetch(attachment.url);
    const buffer = Buffer.from(await response.arrayBuffer());

    // é€çµ¦ Gemini Vision è§£æ
    const calendarData = await geminiService.extractCalendarFromImage(
      buffer,
      attachment.contentType
    );

    // ç§»é™¤è™•ç†ä¸­åæ‡‰
    await message.reactions.cache.get('â³')?.remove();

    // æª¢æŸ¥ä¿¡å¿ƒåº¦
    if (calendarData.confidence < 0.3) {
      return await message.reply({
        content: 'âš ï¸ ç„¡æ³•å¾åœ–ç‰‡ä¸­è­˜åˆ¥å‡ºæ—¥æœŸè³‡è¨Šã€‚\nè«‹ç¢ºèªåœ–ç‰‡å…§å®¹æ¸…æ™°ï¼Œæˆ–æ”¹ç”¨æ–‡å­—è¼¸å…¥ã€‚'
      });
    }

    // å¿«å–è§£æçµæœï¼ˆä¾›æŒ‰éˆ•äº’å‹•ä½¿ç”¨ï¼ŒTTL 1 å°æ™‚ï¼‰
    await cacheAnalysis(message.id, calendarData);

    // é¡¯ç¤ºé è¦½ Embed å’ŒæŒ‰éˆ•
    const { embed, components } = createCalendarPreview(calendarData);

    await message.reply({
      embeds: [embed],
      components: components
    });

  } catch (error) {
    console.error('åœ–ç‰‡è™•ç†å¤±æ•—:', error);
    await message.reactions.cache.get('â³')?.remove();
    await message.react('âŒ');
    await message.reply(`âŒ è™•ç†å¤±æ•—ï¼š${error.message}`);
  }
}

module.exports = { handleImageMessage, SUPPORTED_IMAGE_TYPES };
```

### 5.4 PDF è™•ç†æµç¨‹

```javascript
// handlers/mediaHandler.js (çºŒ)

const pdfParse = require('pdf-parse');

/**
 * è™•ç† PDF è¨Šæ¯
 */
async function handlePdfMessage(message) {
  const attachment = message.attachments.first();

  // é©—è­‰æª”æ¡ˆé¡å‹
  if (attachment.contentType !== 'application/pdf') {
    return;
  }

  // é©—è­‰æª”æ¡ˆå¤§å°
  const MAX_SIZE = 10 * 1024 * 1024;
  if (attachment.size > MAX_SIZE) {
    return await message.reply('âŒ PDF å¤ªå¤§ï¼Œè«‹ä½¿ç”¨å°æ–¼ 10MB çš„æª”æ¡ˆ');
  }

  await message.react('â³');

  try {
    // ä¸‹è¼‰ PDF
    const response = await fetch(attachment.url);
    const buffer = Buffer.from(await response.arrayBuffer());

    // è§£æ PDF æ–‡å­—
    const pdfData = await pdfParse(buffer);
    const text = pdfData.text;

    if (!text || text.trim().length < 10) {
      await message.reactions.cache.get('â³')?.remove();
      return await message.reply('âš ï¸ ç„¡æ³•å¾ PDF ä¸­æå–æ–‡å­—ã€‚å¯èƒ½æ˜¯æƒææª”æˆ–åœ–ç‰‡ PDFï¼Œè«‹æ”¹ç”¨åœ–ç‰‡æ–¹å¼ä¸Šå‚³ã€‚');
    }

    // é€çµ¦ Gemini è§£æ
    const calendarData = await geminiService.extractCalendarFromText(text);

    await message.reactions.cache.get('â³')?.remove();

    if (calendarData.confidence < 0.3) {
      return await message.reply('âš ï¸ ç„¡æ³•å¾ PDF ä¸­è­˜åˆ¥å‡ºæ—¥æœŸè³‡è¨Š');
    }

    await cacheAnalysis(message.id, calendarData);

    const { embed, components } = createCalendarPreview(calendarData);
    await message.reply({ embeds: [embed], components: components });

  } catch (error) {
    console.error('PDF è™•ç†å¤±æ•—:', error);
    await message.reactions.cache.get('â³')?.remove();
    await message.react('âŒ');
    await message.reply(`âŒ PDF è™•ç†å¤±æ•—ï¼š${error.message}`);
  }
}

module.exports = { handleImageMessage, handlePdfMessage, SUPPORTED_IMAGE_TYPES };
```

### 5.5 Google Calendar / Tasks æ•´åˆ

```javascript
// services/google.js

const { google } = require('googleapis');

// OAuth2 è¨­å®š
const oauth2Client = new google.auth.OAuth2(
  process.env.GOOGLE_CLIENT_ID,
  process.env.GOOGLE_CLIENT_SECRET,
  'http://localhost:3000/oauth2callback'
);

// è¨­å®š refresh token
oauth2Client.setCredentials({
  refresh_token: process.env.GOOGLE_REFRESH_TOKEN
});

// å»ºç«‹æœå‹™å¯¦ä¾‹
const calendar = google.calendar({ version: 'v3', auth: oauth2Client });
const tasks = google.tasks({ version: 'v1', auth: oauth2Client });

/**
 * å»ºç«‹ Google Calendar æ´»å‹•
 * @param {Object} eventData - æ´»å‹•è³‡æ–™
 */
async function createCalendarEvent(eventData) {
  const event = {
    summary: eventData.title,
    location: eventData.location || undefined,
    description: eventData.summary || undefined,
    start: {
      dateTime: eventData.startTime
        ? `${eventData.startDate}T${eventData.startTime}:00`
        : undefined,
      date: eventData.startTime ? undefined : eventData.startDate,
      timeZone: 'Asia/Taipei'
    },
    end: {
      dateTime: eventData.endTime
        ? `${eventData.endDate || eventData.startDate}T${eventData.endTime}:00`
        : eventData.startTime
          ? `${eventData.startDate}T${addHour(eventData.startTime)}:00`
          : undefined,
      date: eventData.startTime ? undefined : eventData.endDate || eventData.startDate,
      timeZone: 'Asia/Taipei'
    },
    reminders: {
      useDefault: false,
      overrides: [
        { method: 'popup', minutes: 60 },    // 1 å°æ™‚å‰
        { method: 'popup', minutes: 1440 }   // 1 å¤©å‰
      ]
    }
  };

  const response = await calendar.events.insert({
    calendarId: 'primary',
    resource: event
  });

  return {
    id: response.data.id,
    htmlLink: response.data.htmlLink
  };
}

/**
 * å»ºç«‹ Google Task
 * @param {Object} taskData - ä»»å‹™è³‡æ–™
 */
async function createTask(taskData) {
  // å…ˆå–å¾—é è¨­ä»»å‹™æ¸…å–®
  const taskLists = await tasks.tasklists.list();
  const defaultList = taskLists.data.items?.[0];

  if (!defaultList) {
    throw new Error('æ‰¾ä¸åˆ° Google Tasks æ¸…å–®');
  }

  const task = {
    title: taskData.title,
    notes: taskData.summary || undefined,
    due: taskData.deadline
      ? new Date(taskData.deadline).toISOString()
      : taskData.startDate
        ? new Date(taskData.startDate).toISOString()
        : undefined
  };

  const response = await tasks.tasks.insert({
    tasklist: defaultList.id,
    resource: task
  });

  return {
    id: response.data.id,
    title: response.data.title
  };
}

/**
 * è¼”åŠ©å‡½å¼ï¼šæ™‚é–“åŠ ä¸€å°æ™‚
 */
function addHour(time) {
  const [hours, minutes] = time.split(':').map(Number);
  const newHours = (hours + 1) % 24;
  return `${String(newHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
}

module.exports = { createCalendarEvent, createTask, oauth2Client };
```

### 5.6 æŒ‰éˆ•äº’å‹•è™•ç†

```javascript
// events/interactionCreate.js

const { cacheGet, cacheDelete } = require('../utils/cache');
const googleService = require('../services/google');
const notionService = require('../services/notion');
const { createSuccessEmbed } = require('../components/embeds/successEmbed');

/**
 * è™•ç†è¡Œäº‹æ›†ç›¸é—œæŒ‰éˆ•äº’å‹•
 */
async function handleCalendarInteraction(interaction) {
  const { customId } = interaction;

  // å–å¾—åŸå§‹è¨Šæ¯ IDï¼ˆç”¨æ–¼å¾ cache å–å¾—è³‡æ–™ï¼‰
  const originalMessageId = interaction.message.reference?.messageId;

  if (!originalMessageId) {
    return await interaction.reply({
      content: 'âŒ ç„¡æ³•æ‰¾åˆ°åŸå§‹è¨Šæ¯',
      ephemeral: true
    });
  }

  // å¾ cache å–å¾—è§£æè³‡æ–™
  const calendarData = await cacheGet(originalMessageId);

  if (!calendarData) {
    return await interaction.reply({
      content: 'âŒ è³‡æ–™å·²éæœŸï¼Œè«‹é‡æ–°å‚³é€å…§å®¹',
      ephemeral: true
    });
  }

  // å»¶é²å›æ‡‰ï¼ˆè™•ç†ä¸­ï¼‰
  await interaction.deferUpdate();

  try {
    let result = {};

    switch (customId) {
      case 'calendar_add_event': {
        // æ–°å¢åˆ° Google Calendar
        const event = await googleService.createCalendarEvent(calendarData);
        result.calendar = event;

        // åŒæ™‚å­˜å…¥ Notion
        const notionPage = await notionService.createTaskPage({
          ...calendarData,
          type: 'æ´»å‹•',
          googleLink: event.htmlLink
        });
        result.notion = notionPage;
        break;
      }

      case 'calendar_add_task': {
        // æ–°å¢åˆ° Google Tasks
        const task = await googleService.createTask(calendarData);
        result.task = task;

        // åŒæ™‚å­˜å…¥ Notion
        const notionPage = await notionService.createTaskPage({
          ...calendarData,
          type: 'ä»»å‹™'
        });
        result.notion = notionPage;
        break;
      }

      case 'calendar_notion_only': {
        // åªå­˜ Notion
        const notionPage = await notionService.createTaskPage(calendarData);
        result.notion = notionPage;
        break;
      }

      case 'calendar_cancel': {
        await cacheDelete(originalMessageId);
        return await interaction.editReply({
          content: 'âŒ å·²å–æ¶ˆ',
          embeds: [],
          components: []
        });
      }
    }

    // æ¸…é™¤ cache
    await cacheDelete(originalMessageId);

    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
    const successEmbed = createSuccessEmbed(result);
    await interaction.editReply({
      embeds: [successEmbed],
      components: []
    });

  } catch (error) {
    console.error('äº’å‹•è™•ç†å¤±æ•—:', error);
    await interaction.editReply({
      content: `âŒ æ“ä½œå¤±æ•—ï¼š${error.message}`,
      embeds: [],
      components: []
    });
  }
}

module.exports = { handleCalendarInteraction };
```

---

## 6. Notion è³‡æ–™åº«è¨­è¨ˆ

### 6.1 è³‡æ–™åº« Aï¼šè³‡è¨Šæ”¶é›†

**ä½¿ç”¨ä½ ç¾æœ‰çš„ Line Agent è³‡æ–™åº«ï¼Œæ–°å¢ `source` æ¬„ä½å€åˆ†ä¾†æº**

| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ | æ–°å¢/ä¿ç•™ |
|---------|------|------|----------|
| `title` | Title | æ–‡ç« /å½±ç‰‡æ¨™é¡Œ | ä¿ç•™ |
| `date` | Date | å„²å­˜æ—¥æœŸ | ä¿ç•™ |
| `type` | Select | FB/IG/TH/YT/ç¶²è·¯æ–‡ç« /æ–‡å­—é€Ÿè¨˜ | ä¿ç•™ |
| `url` | URL | åŸå§‹é€£çµ | ä¿ç•™ |
| `Author` | Multi-select | ä½œè€…/é »é“åç¨± | ä¿ç•™ |
| `photo` | Files & media | ç¸®åœ– | ä¿ç•™ |
| `source` | Select | **Line / Discord** | **æ–°å¢** |
| `status` | Select | æœªè®€/å·²è®€ï¼ˆé¸å¡«ï¼‰ | é¸å¡«æ–°å¢ |

### 6.2 è³‡æ–™åº« Bï¼šè¡Œäº‹æ›†/ä»»å‹™

**æ²¿ç”¨ä½  document-processor-plus çš„çµæ§‹**

| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
|---------|------|------|
| `Name` | Title | æ´»å‹•/ä»»å‹™åç¨± |
| `æ—¥æœŸ` | Date | æ´»å‹•æ—¥æœŸæˆ–æˆªæ­¢æ—¥ |
| `é¡å‹` | Select | æ´»å‹• / ä»»å‹™ |
| `å„ªå…ˆç´š` | Select | é«˜ / ä¸­ / ä½ |
| `ç‹€æ…‹` | Select | å¾…è™•ç† / é€²è¡Œä¸­ / å·²å®Œæˆ |
| `ä¾†æº` | Select | Discord / å…¬æ–‡ç³»çµ± / æ‰‹å‹• |
| `Googleé€£çµ` | URL | Google Calendar/Tasks é€£çµ |

### 6.3 Notion æœå‹™å¯¦ä½œ

```javascript
// services/notion.js

const { Client } = require('@notionhq/client');

const notion = new Client({
  auth: process.env.NOTION_API_KEY
});

const INFO_DATABASE_ID = process.env.NOTION_DATABASE_ID_INFO;
const CALENDAR_DATABASE_ID = process.env.NOTION_DATABASE_ID_CALENDAR;

/**
 * å»ºç«‹è³‡è¨Šæ”¶é›†é é¢ï¼ˆ#è³‡è¨Šæ”¶é›† é »é“ç”¨ï¼‰
 */
async function createInfoPage(data) {
  const properties = {
    title: {
      title: [{ text: { content: data.title || 'ç„¡æ¨™é¡Œ' } }]
    },
    date: {
      date: { start: new Date().toISOString().split('T')[0] }
    },
    type: {
      select: { name: data.type || 'ç¶²è·¯æ–‡ç« ' }
    },
    source: {
      select: { name: 'Discord' }
    }
  };

  // é¸å¡«æ¬„ä½
  if (data.url) {
    properties.url = { url: data.url };
  }

  if (data.author) {
    properties.Author = {
      multi_select: [{ name: data.author }]
    };
  }

  const response = await notion.pages.create({
    parent: { database_id: INFO_DATABASE_ID },
    properties: properties,
    // é é¢å…§å®¹
    children: buildInfoPageContent(data)
  });

  return {
    id: response.id,
    url: response.url
  };
}

/**
 * å»ºç«‹è¡Œäº‹æ›†/ä»»å‹™é é¢ï¼ˆ#è¡Œäº‹æ›†åŠ©æ‰‹ é »é“ç”¨ï¼‰
 */
async function createTaskPage(data) {
  const properties = {
    Name: {
      title: [{ text: { content: data.title } }]
    },
    'æ—¥æœŸ': {
      date: {
        start: data.startDate,
        end: data.endDate || undefined
      }
    },
    'é¡å‹': {
      select: { name: data.type === 'event' ? 'æ´»å‹•' : 'ä»»å‹™' }
    },
    'å„ªå…ˆç´š': {
      select: { name: data.priority || 'ä¸­' }
    },
    'ç‹€æ…‹': {
      select: { name: 'å¾…è™•ç†' }
    },
    'ä¾†æº': {
      select: { name: 'Discord' }
    }
  };

  if (data.googleLink) {
    properties['Googleé€£çµ'] = { url: data.googleLink };
  }

  const response = await notion.pages.create({
    parent: { database_id: CALENDAR_DATABASE_ID },
    properties: properties,
    children: buildTaskPageContent(data)
  });

  return {
    id: response.id,
    url: response.url
  };
}

/**
 * æ›´æ–°é é¢å±¬æ€§
 */
async function updatePage(pageId, properties) {
  return await notion.pages.update({
    page_id: pageId,
    properties: properties
  });
}

/**
 * å°å­˜é é¢ï¼ˆè»Ÿåˆªé™¤ï¼‰
 */
async function archivePage(pageId) {
  return await notion.pages.update({
    page_id: pageId,
    archived: true
  });
}

/**
 * å»ºç«‹è³‡è¨Šé é¢å…§å®¹å€å¡Š
 */
function buildInfoPageContent(data) {
  const blocks = [];

  // æ‘˜è¦ï¼ˆå¦‚æœæœ‰ï¼‰
  if (data.description) {
    blocks.push({
      object: 'block',
      type: 'paragraph',
      paragraph: {
        rich_text: [{ type: 'text', text: { content: data.description.slice(0, 2000) } }]
      }
    });
  }

  // åˆ†éš”ç·š
  blocks.push({ object: 'block', type: 'divider', divider: {} });

  // ä¾†æºæ¨™è¨˜
  blocks.push({
    object: 'block',
    type: 'paragraph',
    paragraph: {
      rich_text: [{
        type: 'text',
        text: { content: 'ç”± Discord Bot è‡ªå‹•å»ºç«‹' },
        annotations: { italic: true, color: 'gray' }
      }]
    }
  });

  return blocks;
}

/**
 * å»ºç«‹ä»»å‹™é é¢å…§å®¹å€å¡Š
 */
function buildTaskPageContent(data) {
  const blocks = [];

  // æ‘˜è¦ Callout
  if (data.summary) {
    blocks.push({
      object: 'block',
      type: 'callout',
      callout: {
        rich_text: [{ type: 'text', text: { content: data.summary } }],
        icon: { type: 'emoji', emoji: 'ğŸ“‹' }
      }
    });
  }

  // åœ°é»ï¼ˆå¦‚æœæœ‰ï¼‰
  if (data.location) {
    blocks.push({
      object: 'block',
      type: 'paragraph',
      paragraph: {
        rich_text: [
          { type: 'text', text: { content: 'ğŸ“ åœ°é»ï¼š' }, annotations: { bold: true } },
          { type: 'text', text: { content: data.location } }
        ]
      }
    });
  }

  // è¯çµ¡è³‡è¨Šï¼ˆå¦‚æœæœ‰ï¼‰
  if (data.contact && (data.contact.name || data.contact.phone || data.contact.email)) {
    blocks.push({
      object: 'block',
      type: 'heading_3',
      heading_3: {
        rich_text: [{ type: 'text', text: { content: 'è¯çµ¡è³‡è¨Š' } }]
      }
    });

    const contactLines = [];
    if (data.contact.name) contactLines.push(`æ‰¿è¾¦äººï¼š${data.contact.name}`);
    if (data.contact.phone) contactLines.push(`é›»è©±ï¼š${data.contact.phone}`);
    if (data.contact.email) contactLines.push(`ä¿¡ç®±ï¼š${data.contact.email}`);

    blocks.push({
      object: 'block',
      type: 'paragraph',
      paragraph: {
        rich_text: [{ type: 'text', text: { content: contactLines.join('\n') } }]
      }
    });
  }

  // åˆ†éš”ç·š
  blocks.push({ object: 'block', type: 'divider', divider: {} });

  // ä¾†æºæ¨™è¨˜
  blocks.push({
    object: 'block',
    type: 'paragraph',
    paragraph: {
      rich_text: [{
        type: 'text',
        text: { content: 'ç”± Discord Bot è‡ªå‹•å»ºç«‹' },
        annotations: { italic: true, color: 'gray' }
      }]
    }
  });

  return blocks;
}

module.exports = {
  createInfoPage,
  createTaskPage,
  updatePage,
  archivePage
};
```

---

## 7. Discord äº’å‹•å…ƒä»¶è¨­è¨ˆ

### 7.1 è³‡è¨Šæ”¶é›†æˆåŠŸ Embed

```javascript
// components/embeds/infoCollectEmbed.js

const { EmbedBuilder } = require('discord.js');

const TYPE_COLORS = {
  'YT': 0xFF0000,       // YouTube ç´…
  'FB': 0x1877F2,       // Facebook è—
  'IG': 0xE4405F,       // Instagram ç²‰ç´…
  'TH': 0x000000,       // Threads é»‘
  'ç¶²è·¯æ–‡ç« ': 0x00AA00,  // ç¶ è‰²
  'æ–‡å­—é€Ÿè¨˜': 0x808080   // ç°è‰²
};

/**
 * å»ºç«‹è³‡è¨Šæ”¶é›†æˆåŠŸ Embed
 */
function createInfoCollectEmbed(data) {
  const color = TYPE_COLORS[data.type] || 0x5865F2;

  const embed = new EmbedBuilder()
    .setColor(color)
    .setTitle(truncate(data.title, 256))
    .setDescription(truncate(data.description, 200) || 'ç„¡æè¿°')
    .addFields(
      { name: 'é¡å‹', value: data.type, inline: true },
      { name: 'ä½œè€…', value: data.author || 'æœªçŸ¥', inline: true },
      { name: 'ä¾†æº', value: 'Discord', inline: true }
    )
    .setFooter({ text: `Notion ID: ${data.notionPageId}` })
    .setTimestamp();

  if (data.url) {
    embed.setURL(data.url);
  }

  if (data.thumbnail) {
    embed.setThumbnail(data.thumbnail);
  }

  if (data.notionUrl) {
    embed.addFields({
      name: 'ğŸ“ Notion',
      value: `[æŸ¥çœ‹é é¢](${data.notionUrl})`,
      inline: true
    });
  }

  return embed;
}

function truncate(str, maxLength) {
  if (!str) return '';
  return str.length > maxLength ? str.slice(0, maxLength - 3) + '...' : str;
}

module.exports = { createInfoCollectEmbed, TYPE_COLORS };
```

### 7.2 è¡Œäº‹æ›†é è¦½ Embed + æŒ‰éˆ•

```javascript
// components/embeds/calendarPreviewEmbed.js

const {
  EmbedBuilder,
  ActionRowBuilder,
  ButtonBuilder,
  ButtonStyle
} = require('discord.js');

/**
 * å»ºç«‹è¡Œäº‹æ›†é è¦½ Embed å’ŒæŒ‰éˆ•
 */
function createCalendarPreview(data) {
  const embed = new EmbedBuilder()
    .setColor(0x4285F4) // Google è—
    .setTitle('ğŸ“‹ è§£æçµæœ')
    .addFields(
      { name: 'ğŸ“Œ æ¨™é¡Œ', value: data.title || 'æœªçŸ¥', inline: false },
      { name: 'ğŸ“… æ—¥æœŸ', value: formatDate(data.startDate), inline: true },
      { name: 'ğŸ• æ™‚é–“', value: data.startTime || 'æœªæŒ‡å®š', inline: true },
      { name: 'ğŸ“ åœ°é»', value: data.location || 'æœªæŒ‡å®š', inline: true }
    );

  // æˆªæ­¢æ—¥æœŸï¼ˆå¦‚æœæœ‰ï¼‰
  if (data.deadline) {
    embed.addFields({
      name: 'â° æˆªæ­¢æ—¥æœŸ',
      value: `${formatDate(data.deadline)}${data.deadlineDescription ? ` (${data.deadlineDescription})` : ''}`,
      inline: false
    });
  }

  // æ‘˜è¦ï¼ˆå¦‚æœæœ‰ï¼‰
  if (data.summary) {
    embed.addFields({
      name: 'ğŸ“ æ‘˜è¦',
      value: data.summary,
      inline: false
    });
  }

  // ä¿¡å¿ƒåº¦
  const confidencePercent = Math.round((data.confidence || 0) * 100);
  embed.setFooter({
    text: `ä¿¡å¿ƒåº¦ï¼š${confidencePercent}% | è«‹ç¢ºèªå¾Œé¸æ“‡æ“ä½œ`
  });

  // æŒ‰éˆ•
  const row1 = new ActionRowBuilder().addComponents(
    new ButtonBuilder()
      .setCustomId('calendar_add_event')
      .setLabel('ğŸ“… åŠ åˆ°è¡Œäº‹æ›†')
      .setStyle(ButtonStyle.Primary),
    new ButtonBuilder()
      .setCustomId('calendar_add_task')
      .setLabel('âœ… åŠ åˆ° Tasks')
      .setStyle(ButtonStyle.Success),
    new ButtonBuilder()
      .setCustomId('calendar_notion_only')
      .setLabel('ğŸ“ åªå­˜ Notion')
      .setStyle(ButtonStyle.Secondary)
  );

  const row2 = new ActionRowBuilder().addComponents(
    new ButtonBuilder()
      .setCustomId('calendar_cancel')
      .setLabel('âŒ å–æ¶ˆ')
      .setStyle(ButtonStyle.Danger)
  );

  return {
    embed,
    components: [row1, row2]
  };
}

function formatDate(dateStr) {
  if (!dateStr) return 'æœªæŒ‡å®š';

  try {
    const date = new Date(dateStr);
    return date.toLocaleDateString('zh-TW', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      weekday: 'short'
    });
  } catch {
    return dateStr;
  }
}

module.exports = { createCalendarPreview };
```

### 7.3 æˆåŠŸ Embed

```javascript
// components/embeds/successEmbed.js

const { EmbedBuilder } = require('discord.js');

/**
 * å»ºç«‹æ“ä½œæˆåŠŸ Embed
 */
function createSuccessEmbed(result) {
  const embed = new EmbedBuilder()
    .setColor(0x00FF00)
    .setTitle('âœ… æ“ä½œæˆåŠŸ')
    .setTimestamp();

  const fields = [];

  if (result.calendar) {
    fields.push({
      name: 'ğŸ“… Google Calendar',
      value: `[æŸ¥çœ‹æ´»å‹•](${result.calendar.htmlLink})`,
      inline: true
    });
  }

  if (result.task) {
    fields.push({
      name: 'âœ… Google Tasks',
      value: 'å·²æ–°å¢ä»»å‹™',
      inline: true
    });
  }

  if (result.notion) {
    fields.push({
      name: 'ğŸ“ Notion',
      value: `[æŸ¥çœ‹é é¢](${result.notion.url})`,
      inline: true
    });
  }

  embed.addFields(fields);

  return embed;
}

module.exports = { createSuccessEmbed };
```

---

## 8. éŒ¯èª¤è™•ç†ç­–ç•¥

### 8.1 éŒ¯èª¤åˆ†é¡èˆ‡è™•ç†

| éŒ¯èª¤é¡å‹ | è™•ç†æ–¹å¼ | ä½¿ç”¨è€…å›é¥‹ |
|---------|---------|-----------|
| ç¶²è·¯éŒ¯èª¤ | é‡è©¦ 3 æ¬¡ | ã€Œâ³ ç¶²è·¯é€£ç·šå•é¡Œï¼Œæ­£åœ¨é‡è©¦...ã€ |
| API é™æµ | ç­‰å¾…å¾Œé‡è©¦ | ã€Œâ³ æœå‹™å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€ |
| ç„¡æ•ˆ URL | ç›´æ¥å›å ± | ã€ŒâŒ ç„¡æ³•è¾¨è­˜çš„é€£çµæ ¼å¼ã€ |
| çˆ¬èŸ²å¤±æ•— | é™ç´šè™•ç† | ã€Œâš ï¸ ç„¡æ³•æ“·å–å…§å®¹ï¼Œå·²å„²å­˜é€£çµã€ |
| AI è§£æå¤±æ•— | é™ç´šè™•ç† | ã€Œâš ï¸ AI ç„¡æ³•è§£æï¼Œè«‹å˜—è©¦å…¶ä»–æ–¹å¼ã€ |
| Notion éŒ¯èª¤ | è¨˜éŒ„ + é€šçŸ¥ | ã€ŒâŒ å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€ |
| Google éŒ¯èª¤ | è¨˜éŒ„ + é€šçŸ¥ | ã€ŒâŒ Google æœå‹™é€£ç·šå¤±æ•—ã€ |

### 8.2 é‡è©¦æ©Ÿåˆ¶

```javascript
// utils/retry.js

/**
 * å¸¶é‡è©¦çš„éåŒæ­¥å‡½å¼åŸ·è¡Œ
 */
async function withRetry(fn, options = {}) {
  const {
    maxRetries = 3,
    delay = 1000,
    backoff = 2,
    onRetry = () => {}
  } = options;

  let lastError;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;

      // ä¸é‡è©¦çš„éŒ¯èª¤é¡å‹
      if (error.status === 400 || error.status === 401 || error.status === 403) {
        throw error;
      }

      if (attempt < maxRetries) {
        const waitTime = delay * Math.pow(backoff, attempt - 1);
        onRetry(attempt, waitTime, error);
        await sleep(waitTime);
      }
    }
  }

  throw lastError;
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

module.exports = { withRetry, sleep };
```

### 8.3 å¿«å–æ©Ÿåˆ¶

```javascript
// utils/cache.js

const NodeCache = require('node-cache');

// TTL 1 å°æ™‚ï¼Œæª¢æŸ¥é€±æœŸ 10 åˆ†é˜
const cache = new NodeCache({
  stdTTL: 3600,
  checkperiod: 600
});

/**
 * å„²å­˜è§£æçµæœ
 */
async function cacheAnalysis(messageId, data) {
  cache.set(`analysis:${messageId}`, data);
}

/**
 * å–å¾—è§£æçµæœ
 */
async function cacheGet(messageId) {
  return cache.get(`analysis:${messageId}`);
}

/**
 * åˆªé™¤å¿«å–
 */
async function cacheDelete(messageId) {
  cache.del(`analysis:${messageId}`);
}

module.exports = { cacheAnalysis, cacheGet, cacheDelete };
```

---

## 9. ç’°å¢ƒè®Šæ•¸é…ç½®

### 9.1 .env.example

```env
# ===== Discord =====
# å¾ https://discord.com/developers/applications å–å¾—
DISCORD_TOKEN=ä½ çš„_Discord_Bot_Token
DISCORD_CLIENT_ID=ä½ çš„_Discord_Application_ID

# ===== Notion =====
# å¾ https://www.notion.so/my-integrations å–å¾—
NOTION_API_KEY=ä½ çš„_Notion_Integration_Token
NOTION_DATABASE_ID_INFO=è³‡è¨Šæ”¶é›†è³‡æ–™åº«_ID
NOTION_DATABASE_ID_CALENDAR=è¡Œäº‹æ›†è³‡æ–™åº«_ID

# ===== Google OAuth =====
# å¾ Google Cloud Console å–å¾—
GOOGLE_CLIENT_ID=ä½ çš„_Google_OAuth_Client_ID
GOOGLE_CLIENT_SECRET=ä½ çš„_Google_OAuth_Client_Secret
GOOGLE_REFRESH_TOKEN=ä½ çš„_Google_Refresh_Token

# ===== Gemini AI =====
# å¾ https://aistudio.google.com/apikey å–å¾—
GEMINI_API_KEY=ä½ çš„_Gemini_API_Key
GEMINI_MODEL=gemini-2.5-flash

# ===== Apifyï¼ˆé¸å¡«ï¼‰=====
# å¾ https://console.apify.com/account/integrations å–å¾—
APIFY_API_KEY=ä½ çš„_Apify_API_Key

# ===== ä¼ºæœå™¨è¨­å®š =====
PORT=3000
NODE_ENV=development
```

---

## 10. å°ˆæ¡ˆæª”æ¡ˆçµæ§‹

```
discord-bot/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.js                    # å…¥å£é»
â”‚   â”‚
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ index.js                # è¨­å®šç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ events/                     # Discord äº‹ä»¶
â”‚   â”‚   â”œâ”€â”€ ready.js                # Bot å•Ÿå‹•
â”‚   â”‚   â”œâ”€â”€ messageCreate.js        # æ–°è¨Šæ¯
â”‚   â”‚   â”œâ”€â”€ interactionCreate.js    # æŒ‰éˆ•/é¸å–®äº’å‹•
â”‚   â”‚   â””â”€â”€ messageReactionAdd.js   # åæ‡‰äº‹ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ handlers/                   # è¨Šæ¯è™•ç†å™¨
â”‚   â”‚   â”œâ”€â”€ infoCollectHandler.js   # #è³‡è¨Šæ”¶é›† è™•ç†
â”‚   â”‚   â”œâ”€â”€ calendarHandler.js      # #è¡Œäº‹æ›†åŠ©æ‰‹ è™•ç†
â”‚   â”‚   â”œâ”€â”€ urlHandler.js           # URL è™•ç†
â”‚   â”‚   â”œâ”€â”€ mediaHandler.js         # åœ–ç‰‡/PDF è™•ç†
â”‚   â”‚   â””â”€â”€ textHandler.js          # ç´”æ–‡å­—è™•ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ services/                   # å¤–éƒ¨æœå‹™
â”‚   â”‚   â”œâ”€â”€ notion.js               # Notion API
â”‚   â”‚   â”œâ”€â”€ google.js               # Google Calendar/Tasks
â”‚   â”‚   â”œâ”€â”€ gemini.js               # Gemini AI
â”‚   â”‚   â”œâ”€â”€ apify.js                # Apify çˆ¬èŸ²
â”‚   â”‚   â”œâ”€â”€ youtube.js              # YouTube è™•ç†
â”‚   â”‚   â””â”€â”€ scraper.js              # ç¶²é çˆ¬èŸ²
â”‚   â”‚
â”‚   â”œâ”€â”€ components/                 # Discord å…ƒä»¶
â”‚   â”‚   â””â”€â”€ embeds/
â”‚   â”‚       â”œâ”€â”€ infoCollectEmbed.js
â”‚   â”‚       â”œâ”€â”€ calendarPreviewEmbed.js
â”‚   â”‚       â””â”€â”€ successEmbed.js
â”‚   â”‚
â”‚   â””â”€â”€ utils/                      # å·¥å…·å‡½å¼
â”‚       â”œâ”€â”€ urlParser.js
â”‚       â”œâ”€â”€ cache.js
â”‚       â”œâ”€â”€ retry.js
â”‚       â””â”€â”€ logger.js
â”‚
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ setup-google-auth.js        # Google OAuth è¨­å®šè…³æœ¬
â”‚
â”œâ”€â”€ .env.example
â”œâ”€â”€ .gitignore
â”œâ”€â”€ package.json
â”œâ”€â”€ zeabur.json
â””â”€â”€ README.md
```

---

## 11. éƒ¨ç½²è¦åŠƒ

### 11.1 package.json

```json
{
  "name": "discord-bot",
  "version": "1.0.0",
  "description": "Discord è‡ªå‹•åŒ–è³‡è¨Šæ”¶é›†èˆ‡è¡Œäº‹æ›†åŠ©æ‰‹",
  "main": "src/index.js",
  "type": "module",
  "scripts": {
    "start": "node src/index.js",
    "dev": "node --watch src/index.js"
  },
  "dependencies": {
    "discord.js": "^14.25.1",
    "@google/genai": "^1.37.0",
    "@notionhq/client": "^5.7.0",
    "googleapis": "^144.0.0",
    "apify-client": "^2.11.0",
    "cheerio": "^1.0.0",
    "@mozilla/readability": "^0.5.0",
    "jsdom": "^26.0.0",
    "pdf-parse": "^1.1.1",
    "node-cache": "^5.1.2",
    "dotenv": "^16.4.7",
    "express": "^4.21.0"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
```

### 11.2 zeabur.json

```json
{
  "build": {
    "type": "nodejs"
  },
  "start": {
    "command": "node src/index.js"
  }
}
```

### 11.3 å…¥å£é» (index.js)

```javascript
// src/index.js

import 'dotenv/config';
import { Client, GatewayIntentBits, Events } from 'discord.js';
import express from 'express';

// äº‹ä»¶è™•ç†
import { handleReady } from './events/ready.js';
import { handleMessageCreate } from './events/messageCreate.js';
import { handleInteractionCreate } from './events/interactionCreate.js';
import { handleMessageReactionAdd } from './events/messageReactionAdd.js';

// å»ºç«‹ Discord Client
const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.GuildMessageReactions
  ]
});

// è¨»å†Šäº‹ä»¶
client.once(Events.ClientReady, handleReady);
client.on(Events.MessageCreate, handleMessageCreate);
client.on(Events.InteractionCreate, handleInteractionCreate);
client.on(Events.MessageReactionAdd, handleMessageReactionAdd);

// éŒ¯èª¤è™•ç†
client.on(Events.Error, (error) => {
  console.error('Discord Client Error:', error);
});

process.on('unhandledRejection', (error) => {
  console.error('Unhandled Rejection:', error);
});

// å¥åº·æª¢æŸ¥ä¼ºæœå™¨ï¼ˆZeabur ç”¨ï¼‰
const app = express();

app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    uptime: process.uptime(),
    discord: client.isReady() ? 'connected' : 'disconnected',
    timestamp: new Date().toISOString()
  });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Health check server running on port ${PORT}`);
});

// å•Ÿå‹• Bot
client.login(process.env.DISCORD_TOKEN);
```

---

## 12. æœªä¾†æ“´å……

### 12.1 å¯èƒ½çš„æ–°å¢åŠŸèƒ½

| åŠŸèƒ½ | èªªæ˜ | å„ªå…ˆç´š |
|------|------|--------|
| `/search` æŒ‡ä»¤ | æœå°‹ Notion è³‡æ–™åº« | é«˜ |
| n8n Webhook æ•´åˆ | æ¯æ—¥è¡Œäº‹æ›†æé†’ | é«˜ |
| Thread ç­†è¨˜åŒæ­¥ | è¨è«–ä¸²å…§å®¹åŒæ­¥åˆ° Notion | ä¸­ |
| å¤š Calendar æ”¯æ´ | é¸æ“‡è¦åŠ åˆ°å“ªå€‹è¡Œäº‹æ›† | ä¸­ |
| èªéŸ³è½‰æ–‡å­— | Discord èªéŸ³è¨Šæ¯ | ä½ |

### 12.2 èˆ‡ n8n æ•´åˆé»

```
n8n Workflow:
â”œâ”€â”€ æ¯æ—¥æ—©ä¸Š 8:30
â”‚   â””â”€â”€ æƒæ Google Calendar/Tasks
â”‚   â””â”€â”€ éæ¿¾æœªä¾† 5 å¤©é …ç›®
â”‚   â””â”€â”€ Discord Webhook â†’ #bot-é€šçŸ¥ é »é“
â”‚
â””â”€â”€ è§¸ç™¼æ¢ä»¶ï¼šæœ‰æ–°çš„æœªå®Œæˆä»»å‹™
    â””â”€â”€ ç™¼é€æé†’åˆ° Discord
```

---

## é™„éŒ„ï¼šé—œéµæŠ€è¡“æ±ºç­–

| æ±ºç­– | é¸æ“‡ | ç†ç”± |
|------|------|------|
| Gemini SDK | @google/genai v1.37.0 | æ–°ç‰ˆ SDKï¼Œ@google/generative-ai å·²æ£„ç”¨ |
| Gemini æ¨¡å‹ | gemini-2.5-flash | ç©©å®šã€ä¾¿å®œã€é€Ÿåº¦å¿«ã€æ”¯æ´ Vision |
| Discord æ¡†æ¶ | discord.js 14.25.1 | æœ€æ–°ç©©å®šç‰ˆ |
| Notion SDK | @notionhq/client 5.7.0 | å°æ‡‰ API v2025-09-03 |
| ç¶²é çˆ¬èŸ² | Cheerio + Readability | è¼•é‡ã€é©åˆéœæ…‹é é¢ |
| ç¤¾ç¾¤çˆ¬èŸ² | Apify | ç©©å®šã€æ²¿ç”¨ç¾æœ‰ç¶“é©— |
| å¿«å– | node-cache | ç°¡å–®ã€å–®æ©Ÿéƒ¨ç½²é©ç”¨ |
| éƒ¨ç½² | Zeabur | ä½¿ç”¨è€…ç†Ÿæ‚‰ |

---

*æ–‡ä»¶ç‰ˆæœ¬ï¼š2.0*
*æœ€å¾Œæ›´æ–°ï¼š2025-01-30*
*æŠ€è¡“é©—è­‰æ—¥æœŸï¼š2025-01-30ï¼ˆæ‰€æœ‰ API ç‰ˆæœ¬å·²ç¢ºèªç‚ºæœ€æ–°ï¼‰*
